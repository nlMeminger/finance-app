{% extends "base.html" %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Bill Details: {{ bill.name }}</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('main.bills') }}">Bills</a></li>
                <li class="breadcrumb-item active">{{ bill.name }}</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Bill Information</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Name:</strong> {{ bill.name }}</li>
                            <li class="list-group-item"><strong>Amount:</strong> ${{ "%.2f"|format(bill.amount) }}</li>
                            <li class="list-group-item"><strong>Due Date:</strong> {{ bill.due_date.strftime('%Y-%m-%d') }}</li>
                            <li class="list-group-item"><strong>Recurring:</strong> {{ 'Yes' if bill.recurring else 'No' }}</li>
                            <li class="list-group-item"><strong>Frequency:</strong> {{ bill.frequency }}</li>
                            <li class="list-group-item"><strong>Category:</strong> {{ bill.category }}</li>
                            <li class="list-group-item"><strong>Account:</strong> {{ bill.account.name if bill.account else 'N/A' }}</li>
                            <li class="list-group-item"><strong>Is Credit Card:</strong> {{ 'Yes' if bill.is_credit_card else 'No' }}</li>
                            <li class="list-group-item"><strong>Payment Status:</strong> {{ bill.payment_status.capitalize() }}</li>
                            {% if bill.last_paid_date %}
                            <li class="list-group-item"><strong>Last Paid Date:</strong> {{ bill.last_paid_date.strftime('%Y-%m-%d') }}</li>
                            {% endif %}
                        </ul>
                        {% if bill.payment_status == 'unpaid' %}
                        <button id="mark-paid-btn" class="btn btn-success mt-3" data-id="{{ bill.id }}">Mark as Paid</button>
                        {% endif %}
                        <button class="btn btn-primary mt-3 edit-bill" data-id="{{ bill.id }}">Edit Bill</button>
                        <button class="btn btn-danger mt-3 delete-bill" data-id="{{ bill.id }}">Delete Bill</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Transaction History</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                    <td>${{ "%.2f"|format(transaction.amount) }}</td>
                                    <td>{{ transaction.description }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const markPaidBtn = document.getElementById('mark-paid-btn');
    const editBillBtn = document.querySelector('.edit-bill');
    const deleteBillBtn = document.querySelector('.delete-bill');

    if (markPaidBtn) {
        markPaidBtn.addEventListener('click', function() {
            const billId = this.getAttribute('data-id');
            fetch(`/bills/${billId}/mark_paid`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error marking bill as paid');
            });
        });
    }

    if (editBillBtn) {
        editBillBtn.addEventListener('click', function() {
            const billId = this.getAttribute('data-id');
            window.location.href = `/bills/${billId}/edit`;
        });
    }

    if (deleteBillBtn) {
        deleteBillBtn.addEventListener('click', function() {
            const billId = this.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this bill?')) {
                fetch(`/bills/${billId}/delete`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        window.location.href = '/bills';
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Error deleting bill');
                });
            }
        });
    }
});
</script>
{% endblock %}